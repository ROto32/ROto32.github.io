<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Key Management Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-lua.min.js"></script>
</head>
<body>
  <div id="login-container">
    <h1>Login</h1>
    <label>Username:</label>
    <input type="text" id="username" placeholder="Enter username" />
    <label>Password:</label>
    <input type="password" id="password" placeholder="Enter password" />
    <label>
      <input type="checkbox" id="rememberMe"> Remember Me
    </label>
    <button onclick="login()">Login</button>
    <div id="loginStatus" class="output"></div>
  </div>

  <div id="dashboard" style="display: none;">
    <!-- Tabs and Tab Contents as in your original code -->
  </div>

  <script>
    const JSONBIN_API_KEY = "$2a$10$nINI7pBO7a.W7H0knci4VehSa2YblgI/5pz/FMsoroByYUqKO./Ju"; 
    const BIN_ID = "672e5527e41b4d34e450f833";

    if (localStorage.getItem("loggedIn") === "true") {
      document.getElementById("login-container").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      openTab('keys'); 
    }

    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const rememberMe = document.getElementById("rememberMe").checked;

      if (username === "droid" && password === "lolimdroid991") {
        if (rememberMe) {
          localStorage.setItem("loggedIn", "true");
        }
        document.getElementById("login-container").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        openTab('keys');
      } else {
        document.getElementById("loginStatus").innerText = "Invalid username or password.";
      }
    }

    function logout() {
      localStorage.removeItem("loggedIn");
      document.getElementById("login-container").style.display = "block";
      document.getElementById("dashboard").style.display = "none";
    }

    function openTab(tabName) {
      const contents = document.getElementsByClassName("tab-content");
      for (let content of contents) {
        content.style.display = "none";
      }
      document.getElementById(tabName).style.display = "block";
    }

    function generateRandomKey() {
      const prefix = "KEY-";
      const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let randomPart = "";

      for (let i = 0; i < 7; i++) {
        randomPart += characters.charAt(Math.floor(Math.random() * characters.length));
      }

      return prefix + randomPart;
    }

    async function loadStoredKeys() {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: {
            "X-Master-Key": JSONBIN_API_KEY
          }
        });
        const data = await response.json();
        const storedKeys = data.record.keys || [];

        const keyList = document.getElementById("keyList");
        keyList.innerHTML = "";

        const userGeneratedKeys = document.getElementById("userGeneratedKeys");
        userGeneratedKeys.innerHTML = "";

        storedKeys.forEach(keyData => {
          const keyItem = `${keyData.key} - Expires on: ${new Date(keyData.expiresAt).toLocaleString()}`;
          
          const listItem = document.createElement("li");
          listItem.textContent = keyItem;
          keyList.appendChild(listItem);

          const userItem = document.createElement("li");
          userItem.textContent = keyItem;
          userGeneratedKeys.appendChild(userItem);
        });
      } catch (error) {
        console.error("Failed to load keys:", error);
      }
    }

    async function generateKey() {
      const durationType = document.getElementById("durationType").value;
      const durationValue = parseInt(document.getElementById("durationValue").value);

      let expirationDate = new Date();
      switch (durationType) {
        case "hours":
          expirationDate.setHours(expirationDate.getHours() + durationValue);
          break;
        case "days":
          expirationDate.setDate(expirationDate.getDate() + durationValue);
          break;
        case "months":
          expirationDate.setMonth(expirationDate.getMonth() + durationValue);
          break;
        case "years":
          expirationDate.setFullYear(expirationDate.getFullYear() + durationValue);
          break;
        default:
          document.getElementById("generatedKey").innerText = "Invalid duration type.";
          return;
      }

      const newKey = {
        key: generateRandomKey(),
        expiresAt: expirationDate.toISOString(),
        userId: null // User ID will be set upon first use
      };

      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: {
            "X-Master-Key": JSONBIN_API_KEY
          }
        });
        const data = await response.json();
        const storedKeys = data.record.keys || [];

        storedKeys.push(newKey);

        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": JSONBIN_API_KEY,
            "X-Bin-Versioning": "false"
          },
          body: JSON.stringify({ keys: storedKeys })
        });

        document.getElementById("generatedKey").innerText = `Generated Key: ${newKey.key} (Expires on: ${expirationDate.toLocaleString()})`;
        
        loadStoredKeys();
      } catch (error) {
        console.error("Failed to save key:", error);
        document.getElementById("generatedKey").innerText = "Error generating key.";
      }
    }

    async function validateKey(userKey, userId) {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: {
            "X-Master-Key": JSONBIN_API_KEY
          }
        });
        const data = await response.json();
        const storedKeys = data.record.keys || [];

        const keyData = storedKeys.find(key => key.key === userKey);

        if (!keyData) {
          console.log("Invalid key.");
          return false;
        }

        if (keyData.expiresAt < new Date().toISOString()) {
          console.log("Key expired.");
          return false;
        }

        if (!keyData.userId) {
          keyData.userId = userId; // Lock key to this user ID

          await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": JSONBIN_API_KEY,
              "X-Bin-Versioning": "false"
            },
            body: JSON.stringify({ keys: storedKeys })
          });
          
          console.log("Key is valid and now locked to user ID:", userId);
          return true;
        }

        if (keyData.userId === userId) {
          console.log("Key is valid for user ID:", userId);
          return true;
        } else {
          console.log("Key is locked to a different user.");
          return false;
        }
      } catch (error) {
        console.error("Failed to validate key:", error);
        return false;
      }
    }

    loadStoredKeys();
  </script>
</body>
</html>
